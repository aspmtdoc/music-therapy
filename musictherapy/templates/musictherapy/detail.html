{% load template_getattr %}
{% load crispy_forms_tags %}

<!DOCTYPE html>

<html>
    <head>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">
        <!-- Latest compiled and minified JavaScript -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
        <style type="text/css">
            .forms-wrapper{
                margin: 20px;
            }

            .page-wrapper {
                margin-top: 20px;
                margin-bottom: 20px;
            }
        </style>

        <script type="text/javascript">
            $(document).ready(function() {
                var url = document.location.toString();
                if (url.match('#')) {
                    $('.nav-tabs a[href=#'+url.split('#')[1]+']').tab('show');
                }

                $('.nav-tabs a').on('shown.bs.tab', function (e) {
                    window.location.hash = e.target.hash;
                });

                $('a[data-toggle="tab"]').on('shown', function (e) {
                    $('.dropdown-menu li.active').removeClass('active');
                    $(this).parent('li').addClass('active');
                });

            });
        </script>

        <!-- PyGal scripts -->
        <script type="text/javascript" src="https://kozea.github.com/pygal.js/latest/pygal-tooltips.min.js"></script>
    </head>

    <body>
        <div class="page-wrapper">
            {% load crispy_forms_tags %}

            <ul class ="nav nav-tabs" id="tabs">
                <li class="active"><a data-toggle="tab" href="#basicinfo">Basic Information</a></li>
                {% if summary %}
                <li><a data-toggle="tab" href="#summary">Summary</a></li>
                {% endif %}
                {% if goals %}
                <li><a data-toggle="tab" href="#goals">Treatment Plan</a></li>
                {% endif %}
                {% if session_goals %}
                <li><a data-toggle="tab" href="#sessiongoals">Session Goals</a></li>
                {% endif %}
                {% if musical_pref_form %}
                <li><a data-toggle="tab" href="#musicpref">Musical Preference</a></li>
                {% endif %}
                {% if general_goals %}
                <li><a data-toggle="tab" href="#generalgoals">General Goals</a></li>
                {% endif %}
                {% if com_data %}
                <li><a data-toggle="tab" href="#comskills">Communication Skills</a></li>
                {% endif %}
                {% if pss_data %}
                <li><a data-toggle="tab" href="#pssskills">Psycho-Social Skills</a></li>
                {% endif %}
                {% if physical_data %}
                <li><a data-toggle="tab" href="#physicalskills">Physical Skills</a></li>
                {% endif  %}
                {% if cog_data %}
                <li><a data-toggle="tab" href="#cogskills">Cognitive and Memory Skills</a></li>
                {% endif %}
                {% if affective_data %}
                <li><a data-toggle="tab" href="#affectiveskills">Affective Skills</a></li>
                {% endif %}
                {% if music_data %}
                <li><a data-toggle="tab" href="#musicskills">Music Skills</a></li>
                {% endif %}
                <li><a class="btn" href="/musictherapy/logout">Logout</a></li>
                <li><a class="btn" href="/musictherapy/patients">Back to Index</a></li>
            </ul>

            <div class="tab-content forms-wrapper">
                <div id="goals" class="tab-pane fade">
                    {% include "musictherapy/goals.html" with goals=goals %}
                </div>

                <div id="sessiongoals" class="tab-pane fade">
                    {% include "musictherapy/session_goals.html" with goals=session_goals %}
                </div>

                <div id ="musicpref" class="tab-pane fade">
                    {% if musical_pref_form %}
                        {% crispy musical_pref_form %}

                        {% if musicpref_last_updated %}
                        <p>Last updated {{ musicpref_last_updated }}</p>
                        {% endif %}
                    {% endif %}
                </div>

                <div id="basicinfo" class="tab-pane fade in active">
                    <form action="{% url 'musictherapy:save_userinfo' user.id %}" class="form-horizontal" method="post">
                        {% crispy user_info_form %}

                        <div class="form-actions">
                            <button type="button" class="btn btn-primary btn-md" data-toggle="modal" data-target="#new-program-modal">Add New Program</button>
                        </div>

                        <br/>

                        <div class="form-actions">
                            <input type="submit" name="submit" value="Save" class="btn btn-primary" id="submit-id-submit"/>
                        </div>
                    </form>

                    <div class="modal fade" id="new-program-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                      <div class="modal-dialog" role="document">
                        <div class="modal-content">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="myModalLabel">Add New Program</h4>
                          </div>
                          <div class="modal-body">
                              <form action="{% url 'musictherapy:save_program' %}" class="form-horizontal" method="post" id="new-program-form">
                                  <h4 id="new-program-form-error" style="color: red"></h4>
                                {% crispy program_form %}
                              </form>
                          </div>
                          <div class="modal-footer">
                            <input type="submit" name="submit" value="Save" class="btn btn-primary" form="new-program-form"/>
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                          </div>
                        </div>
                      </div>
                    </div>

                    {% if user_last_update %}
                    <p>Last updated {{ user_last_updated }} </p>
                    {% endif %}
                </div>

                <div id="summary" class="tab-pane fade">
                    {% for domain, domain_data in summary.items %}
                        {% if forloop.counter0|divisibleby:2 %}
                        <div class="row">
                            <div class="col-md-6">
                                {% include "musictherapy/summary_data.html" with summary=domain_data type=domain %}
                            </div>
                        {% else %}
                            <div class="col-md-6">
                                {% include "musictherapy/summary_data.html" with summary=domain_data type=domain %}
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                    {% if not summary|length|divisibleby:2 %}
                        </div>
                    {% endif %}
                </div>

                <div id="generalgoals" class="tab-pane fade">
                    {% include "musictherapy/skill.html" with type="General" pre="general" data=general_goals %}
                </div>

                <div id="comskills" class="tab-pane fade">
                    {% include "musictherapy/skill.html" with type="Communication" pre="com" data=com_data %}
                </div>

                <div id="pssskills" class="tab-pane fade">
                    {% include "musictherapy/skill.html" with type="Psycho-Social" pre="pss" data=pss_data %}
                </div>

                <div id="physicalskills" class="tab-pane fade">
                    {% include "musictherapy/skill.html" with type="Physical" pre="physical" data=physical_data %}
                </div>

                <div id="cogskills" class="tab-pane fade">
                    {% include "musictherapy/skill.html" with type="Cognitive and Memory" pre="cog" data=cog_data %}
                </div>

                <div id="musicskills" class="tab-pane fade">
                    {% include "musictherapy/skill.html" with type="Music" pre="music" data=music_data %}
                </div>

                <div id="affectiveskills" class="tab-pane fade">
                    {% include "musictherapy/skill.html" with type="Affective" pre="affective" data=affective_data %}
                </div>
            </div>
        </div>
    </body>

<script type="text/javascript">
$("#new-program-form").submit(function(e) {
    e.preventDefault();
    $form = $(this);
    var url = $form.attr('action');
    var errorText = $("#new-program-form-error");
    errorText.html('');

    $.ajax({
        type: "POST",
        url: url,
        dataType: 'json',
        data: $("#new-program-form").serialize(),
        success: function(data) {
            if (data == 404) {
                errorText.html("There was a problem saving the program, try again later.");
            } else {
                console.log("I made it back, with some data:");
                console.log(data);

                console.log(data["display"]);
                console.log(data["pk"]);
                var option = $("<option>" + data["display"] + "</option>");
                option.attr('value', data["pk"]);
                $('#id_program').append(option);
                $('#id_program option[value='+data["pk"] +']').attr("selected", "selected");
                $('#new-program-modal').modal('toggle');
            }
        }
    });
});
</script>


</html>